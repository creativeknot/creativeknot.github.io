const p={context:void 0,registry:void 0};function E(t){p.context=t}function j(){return{...p.context,id:`${p.context.id}${p.context.count++}-`,count:0}}const V=(t,e)=>t===e,v={equals:V};let O=H;const a=1,w=2,T={owned:null,cleanups:null,context:null,owner:null};var o=null;let A=null,u=null,i=null,c=null,y=0;function z(t,e){const s=u,n=o,r=t.length===0,l=r?T:{owned:null,cleanups:null,context:null,owner:e===void 0?n:e},f=r?t:()=>t(()=>h(()=>S(l)));o=l,u=null;try{return g(f,!0)}finally{u=s,o=n}}function B(t,e){e=e?Object.assign({},v,e):v;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),F(s,r));return[D.bind(s),n]}function $(t,e,s){const n=C(t,e,!1,a);b(n)}function J(t,e,s){O=Q;const n=C(t,e,!1,a),r=k&&U(o,k.id);r&&(n.suspense=r),(!s||!s.render)&&(n.user=!0),c?c.push(n):b(n)}function N(t,e,s){s=s?Object.assign({},v,s):v;const n=C(t,e,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,b(n),D.bind(n)}function h(t){if(u===null)return t();const e=u;u=null;try{return t()}finally{u=e}}function K(t,e){const s=Symbol("context");return{id:s,Provider:q(s),defaultValue:t}}function X(t){let e;return(e=U(o,t.id))!==void 0?e:t.defaultValue}function G(t){const e=N(t),s=N(()=>m(e()));return s.toArray=()=>{const n=s();return Array.isArray(n)?n:n!=null?[n]:[]},s}let k;function D(){if(this.sources&&this.state)if(this.state===a)b(this);else{const t=i;i=null,g(()=>d(this),!1),i=t}if(u){const t=this.observers?this.observers.length:0;u.sources?(u.sources.push(this),u.sourceSlots.push(t)):(u.sources=[this],u.sourceSlots=[t]),this.observers?(this.observers.push(u),this.observerSlots.push(u.sources.length-1)):(this.observers=[u],this.observerSlots=[u.sources.length-1])}return this.value}function F(t,e,s){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&g(()=>{for(let r=0;r<t.observers.length;r+=1){const l=t.observers[r],f=A&&A.running;f&&A.disposed.has(l),(f?!l.tState:!l.state)&&(l.pure?i.push(l):c.push(l),l.observers&&L(l)),f||(l.state=a)}if(i.length>1e6)throw i=[],new Error},!1)),e}function b(t){if(!t.fn)return;S(t);const e=o,s=u,n=y;u=o=t,I(t,t.value,n),u=s,o=e}function I(t,e,s){let n;try{n=t.fn(e)}catch(r){return t.pure&&(t.state=a,t.owned&&t.owned.forEach(S),t.owned=null),t.updatedAt=s+1,P(r)}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?F(t,n):t.value=n,t.updatedAt=s)}function C(t,e,s,n=a,r){const l={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:o,context:null,pure:s};return o===null||o!==T&&(o.owned?o.owned.push(l):o.owned=[l]),l}function x(t){if(t.state===0)return;if(t.state===w)return d(t);if(t.suspense&&h(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<y);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===a)b(t);else if(t.state===w){const n=i;i=null,g(()=>d(t,e[0]),!1),i=n}}function g(t,e){if(i)return t();let s=!1;e||(i=[]),c?s=!0:c=[],y++;try{const n=t();return M(s),n}catch(n){s||(c=null),i=null,P(n)}}function M(t){if(i&&(H(i),i=null),t)return;const e=c;c=null,e.length&&g(()=>O(e),!1)}function H(t){for(let e=0;e<t.length;e++)x(t[e])}function Q(t){let e,s=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[s++]=n:x(n)}for(p.context&&E(),e=0;e<s;e++)x(t[e])}function d(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const n=t.sources[s];if(n.sources){const r=n.state;r===a?n!==e&&(!n.updatedAt||n.updatedAt<y)&&x(n):r===w&&d(n,e)}}}function L(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=w,s.pure?i.push(s):c.push(s),s.observers&&L(s))}}function S(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),n=t.sourceSlots.pop(),r=s.observers;if(r&&r.length){const l=r.pop(),f=s.observerSlots.pop();n<r.length&&(l.sourceSlots[f]=n,r[n]=l,s.observerSlots[n]=f)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)S(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0,t.context=null}function W(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function P(t,e=o){throw W(t)}function U(t,e){return t?t.context&&t.context[e]!==void 0?t.context[e]:U(t.owner,e):void 0}function m(t){if(typeof t=="function"&&!t.length)return m(t());if(Array.isArray(t)){const e=[];for(let s=0;s<t.length;s++){const n=m(t[s]);Array.isArray(n)?e.push.apply(e,n):e.push(n)}return e}return t}function q(t,e){return function(n){let r;return $(()=>r=h(()=>(o.context={[t]:n.value},G(()=>n.children))),void 0),r}}let R=!1;function Y(){R=!0}function Z(t,e){if(R&&p.context){const s=p.context;E(j());const n=h(()=>t(e||{}));return E(s),n}return h(()=>t(e||{}))}export{Z as a,z as b,$ as c,B as d,Y as e,J as f,X as g,K as h,p as s,h as u};
